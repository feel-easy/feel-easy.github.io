<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <title>MySQL · 最佳实践 · 如何索引JSON字段  我的主页</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/iLiKE.css">
    
  
  
    <!-- Highlight.js -->
    <link rel="stylesheet"
          href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js">
    </script>
    <script>
        hljs.initHighlightingOnLoad();
    </script>
  
  
<meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="我的主页" type="application/atom+xml">
</head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <!-- <img src="/favicon.ico"></img> -->
        </a>
      </div>
      <div class="menu-right">
        
          
          
          
          
          
          <a href="/">首页</a>
        
          
          
          
          
          
          <a href="/archives">归档</a>
        
      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">MySQL · 最佳实践 · 如何索引JSON字段</h1>
<article class="post markdown-style">
  <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>MySQL从5.7.8起开始支持JSON字段，这极大的丰富了MySQL的数据类型。也方便了广大开发人员。但MySQL并没有提供对JSON对象中的字段进行索引的功能，至少没有直接对其字段进行索引的方法。本文将介绍利用MySQL 5.7中的虚拟字段的功能来对JSON对象中的字段进行索引。</p>
<h3 id="示例数据"><a href="#示例数据" class="headerlink" title="示例数据"></a>示例数据</h3><p>我们将基于下面的JSON对象进行演示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: 1,  </span><br><span class="line">    &quot;name&quot;: &quot;Sally&quot;,  </span><br><span class="line">    &quot;games_played&quot;:&#123;    </span><br><span class="line">       &quot;Battlefield&quot;: &#123;</span><br><span class="line">          &quot;weapon&quot;: &quot;sniper rifle&quot;,</span><br><span class="line">          &quot;rank&quot;: &quot;Sergeant V&quot;,</span><br><span class="line">          &quot;level&quot;: 20</span><br><span class="line">        &#125;,                                                                                                                          </span><br><span class="line">       &quot;Crazy Tennis&quot;: &#123;</span><br><span class="line">          &quot;won&quot;: 4,</span><br><span class="line">          &quot;lost&quot;: 1</span><br><span class="line">        &#125;,  </span><br><span class="line">       &quot;Puzzler&quot;: &#123;</span><br><span class="line">          &quot;time&quot;: 7</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>表的基本结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;players&#96; (  </span><br><span class="line">    &#96;id&#96; INT UNSIGNED NOT NULL,</span><br><span class="line">    &#96;player_and_games&#96; JSON NOT NULL,</span><br><span class="line">    PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>如果只是基于上面的表的结构我们是无法对JSON字段中的Key进行索引的。接下来我们演示如何借助虚拟字段对其进行索引</p>
<h3 id="增加虚拟字段"><a href="#增加虚拟字段" class="headerlink" title="增加虚拟字段"></a>增加虚拟字段</h3><p>虚拟列语法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;type&gt; [ GENERATED ALWAYS ] AS ( &lt;expression&gt; ) [ VIRTUAL|STORED ]</span><br><span class="line">[ UNIQUE [KEY] ] [ [PRIMARY] KEY ] [ NOT NULL ] [ COMMENT &lt;text&gt; ]</span><br></pre></td></tr></table></figure>
<p>在MySQL 5.7中，支持两种Generated Column，即Virtual Generated Column和Stored Generated Column，前者只将Generated Column保存在数据字典中（表的元数据），并不会将这一列数据持久化到磁盘上；后者会将Generated Column持久化到磁盘上，而不是每次读取的时候计算所得。很明显，后者存放了可以通过已有数据计算而得的数据，需要更多的磁盘空间，与Virtual Column相比并没有优势，因此，MySQL 5.7中，不指定Generated Column的类型，默认是Virtual Column。</p>
<p>如果需要Stored Generated Golumn的话，可能在Virtual Generated Column上建立索引更加合适，一般情况下，都使用Virtual Generated Column，这也是MySQL默认的方式</p>
<p>加完虚拟列的建表语句如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;players&#96; (  </span><br><span class="line">   &#96;id&#96; INT UNSIGNED NOT NULL,</span><br><span class="line">   &#96;player_and_games&#96; JSON NOT NULL,</span><br><span class="line">   &#96;names_virtual&#96; VARCHAR(20) GENERATED ALWAYS AS (&#96;player_and_games&#96; -&gt;&gt; &#39;$.name&#39;) NOT NULL, </span><br><span class="line">   PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>Note: 利用操作符-» 来引用JSON字段中的KEY。在本例中字段names_virtual为虚拟字段，我把它定义成不可以为空。在实际的工作中，一定要集合具体的情况来定。因为JSON本身是一种弱结构的数据对象。也就是说的它的结构不是固定不变的。</p>
<p>我们插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;players&#96; (&#96;id&#96;, &#96;player_and_games&#96;) VALUES (1, &#39;&#123;  </span><br><span class="line">    &quot;id&quot;: 1,  </span><br><span class="line">    &quot;name&quot;: &quot;Sally&quot;,</span><br><span class="line">    &quot;games_played&quot;:&#123;    </span><br><span class="line">       &quot;Battlefield&quot;: &#123;</span><br><span class="line">          &quot;weapon&quot;: &quot;sniper rifle&quot;,</span><br><span class="line">          &quot;rank&quot;: &quot;Sergeant V&quot;,</span><br><span class="line">          &quot;level&quot;: 20</span><br><span class="line">        &#125;,                                                                                                                          </span><br><span class="line">       &quot;Crazy Tennis&quot;: &#123;</span><br><span class="line">          &quot;won&quot;: 4,</span><br><span class="line">          &quot;lost&quot;: 1</span><br><span class="line">        &#125;,  </span><br><span class="line">       &quot;Puzzler&quot;: &#123;</span><br><span class="line">          &quot;time&quot;: 7</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;&#39;</span><br><span class="line">);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>查看表里的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM &#96;players&#96;;</span><br><span class="line"></span><br><span class="line">+----+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+</span><br><span class="line">| id | player_and_games                                                                                                                                                                                           | names_virtual |</span><br><span class="line">+----+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+</span><br><span class="line">|  1 | &#123;&quot;id&quot;: 1, &quot;name&quot;: &quot;Sally&quot;, &quot;games_played&quot;: &#123;&quot;Puzzler&quot;: &#123;&quot;time&quot;: 7&#125;, &quot;Battlefield&quot;: &#123;&quot;rank&quot;: &quot;Sergeant V&quot;, &quot;level&quot;: 20, &quot;weapon&quot;: &quot;sniper rifle&quot;&#125;, &quot;Crazy Tennis&quot;: &#123;&quot;won&quot;: 4, &quot;lost&quot;: 1&#125;&#125;&#125;                  | Sally         |</span><br><span class="line">|  2 | &#123;&quot;id&quot;: 2, &quot;name&quot;: &quot;Thom&quot;, &quot;games_played&quot;: &#123;&quot;Puzzler&quot;: &#123;&quot;time&quot;: 25&#125;, &quot;Battlefield&quot;: &#123;&quot;rank&quot;: &quot;Major General VIII&quot;, &quot;level&quot;: 127, &quot;weapon&quot;: &quot;carbine&quot;&#125;, &quot;Crazy Tennis&quot;: &#123;&quot;won&quot;: 10, &quot;lost&quot;: 30&#125;&#125;&#125;            | Thom          |</span><br><span class="line">|  3 | &#123;&quot;id&quot;: 3, &quot;name&quot;: &quot;Ali&quot;, &quot;games_played&quot;: &#123;&quot;Puzzler&quot;: &#123;&quot;time&quot;: 12&#125;, &quot;Battlefield&quot;: &#123;&quot;rank&quot;: &quot;First Sergeant II&quot;, &quot;level&quot;: 37, &quot;weapon&quot;: &quot;machine gun&quot;&#125;, &quot;Crazy Tennis&quot;: &#123;&quot;won&quot;: 30, &quot;lost&quot;: 21&#125;&#125;&#125;           | Ali           |</span><br><span class="line">|  4 | &#123;&quot;id&quot;: 4, &quot;name&quot;: &quot;Alfred&quot;, &quot;games_played&quot;: &#123;&quot;Puzzler&quot;: &#123;&quot;time&quot;: 10&#125;, &quot;Battlefield&quot;: &#123;&quot;rank&quot;: &quot;Chief Warrant Officer Five III&quot;, &quot;level&quot;: 73, &quot;weapon&quot;: &quot;pistol&quot;&#125;, &quot;Crazy Tennis&quot;: &#123;&quot;won&quot;: 47, &quot;lost&quot;: 2&#125;&#125;&#125; | Alfred        |</span><br><span class="line">|  5 | &#123;&quot;id&quot;: 5, &quot;name&quot;: &quot;Phil&quot;, &quot;games_played&quot;: &#123;&quot;Puzzler&quot;: &#123;&quot;time&quot;: 7&#125;, &quot;Battlefield&quot;: &#123;&quot;rank&quot;: &quot;Lt. Colonel III&quot;, &quot;level&quot;: 98, &quot;weapon&quot;: &quot;assault rifle&quot;&#125;, &quot;Crazy Tennis&quot;: &#123;&quot;won&quot;: 130, &quot;lost&quot;: 75&#125;&#125;&#125;          | Phil          |</span><br><span class="line">|  6 | &#123;&quot;id&quot;: 6, &quot;name&quot;: &quot;Henry&quot;, &quot;games_played&quot;: &#123;&quot;Puzzler&quot;: &#123;&quot;time&quot;: 17&#125;, &quot;Battlefield&quot;: &#123;&quot;rank&quot;: &quot;Captain II&quot;, &quot;level&quot;: 87, &quot;weapon&quot;: &quot;assault rifle&quot;&#125;, &quot;Crazy Tennis&quot;: &#123;&quot;won&quot;: 68, &quot;lost&quot;: 149&#125;&#125;&#125;             | Henry         |</span><br><span class="line">+----+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+</span><br></pre></td></tr></table></figure>
<p>查看表Players的字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SHOW COLUMNS FROM &#96;players&#96;;</span><br><span class="line"></span><br><span class="line">+------------------+------------------+------+-----+---------+-------------------+</span><br><span class="line">| Field            | Type             | Null | Key | Default | Extra             |</span><br><span class="line">+------------------+------------------+------+-----+---------+-------------------+</span><br><span class="line">| id               | int(10) unsigned | NO   | PRI | NULL    |                   |</span><br><span class="line">| player_and_games | json             | NO   |     | NULL    |                   |</span><br><span class="line">| names_virtual    | varchar(20)      | NO   |     | NULL    | VIRTUAL GENERATED |</span><br><span class="line">+------------------+------------------+------+-----+---------+-------------------+</span><br></pre></td></tr></table></figure>
<p>我们看到虚拟字段names_virtual的类型是VIRTUAL GENERATED。MySQL只是在数据字典里保存该字段元数据，并没有真正的存储该字段的值。这样表的大小并没有增加。我们可以利用索引把这个字段上的值进行物理存储。</p>
<h3 id="在虚拟字段上加索引"><a href="#在虚拟字段上加索引" class="headerlink" title="在虚拟字段上加索引"></a>在虚拟字段上加索引</h3><p>再添加索引之前，让我们先看下面查询的执行计划</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM &#96;players&#96; WHERE &#96;names_virtual&#96; &#x3D; &quot;Sally&quot;\G  </span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: players</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL  </span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 6</span><br><span class="line">     filtered: 16.67</span><br><span class="line">        Extra: Using where</span><br></pre></td></tr></table></figure>
<p>添加索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX &#96;names_idx&#96; ON &#96;players&#96;(&#96;names_virtual&#96;);  </span><br></pre></td></tr></table></figure>
<p>再执行上面的查询语句，我们将得到不一样的执行计划</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM &#96;players&#96; WHERE &#96;names_virtual&#96; &#x3D; &quot;Sally&quot;\G  </span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: players</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: ref</span><br><span class="line">possible_keys: names_idx  </span><br><span class="line">          key: names_idx</span><br><span class="line">      key_len: 22</span><br><span class="line">          ref: const</span><br><span class="line">         rows: 1</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: NULL</span><br></pre></td></tr></table></figure>
<p>如我们所见，最新的执行计划走了新建的索引。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文介绍了如何在MySQL 5.7中保存JSON文档。为了高效的检索JSON中内容，我们可以利用5.7的虚拟字段来对JSON的不同的KEY来建索引。极大的提高检索的速度。</p>

</article>

    <div class="pagenator post-pagenator">
    
    
        <a class="extend prev post-prev" href="/2023/03/30/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">prev</a>
    

    
    <p>last update time 2023-06-06</p>
    
    
        <a class="extend next post-next" href="/2023/02/06/MYSQL%E4%B8%AD%E7%9A%84json%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C/">next</a>
    
    </div>


    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">
		
			
				
				
				<li>
					<a href="mailto:867869344@qq.com" title="email" target="_blank">
					<i class="fa fa-email"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://github.com/feel-easy" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://www.jianshu.com/u/df8ad5309e07" title="jianshu" target="_self">
					<i class="fa fa-jianshu"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
	</ul>
</div>
    <div class="copyright">
        <span>
            
            
            
                © len 2021 - 2024
            
        </span>
        <span>
            <a href="https://beian.miit.gov.cn/" target="_blank">京ICP备2022032160号-1</a>
        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->

</div>

    </div>
</body>
</html>
